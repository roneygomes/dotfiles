#!/bin/bash

# Usage: worktree-switch <branch_name>
# Creates and switches to a worktree for the given branch in a bare-cloned project

set -e

BRANCH_INPUT=$1

if [ -z "$BRANCH_INPUT" ]; then
    echo "Usage: worktree-switch <branch_name>"
    echo ""
    echo "Examples:"
    echo "  worktree-switch my-feature          # Creates worktree for branch"
    echo "  worktree-switch feat/my-feature     # Handles branch prefixes"
    echo "  worktree-switch 123                 # Works with ticket numbers"
    exit 1
fi

# Check if we're in a bare git repository structure
if [ ! -d ".bare" ] && [ ! -f ".git" ]; then
    echo "Error: Not in a bare-cloned project directory."
    echo "This script works with projects set up using setup-project."
    exit 1
fi

# Ensure we have a .bare directory
if [ ! -d ".bare" ]; then
    echo "Error: .bare directory not found."
    exit 1
fi

# Fetch latest from remote
echo "Fetching latest branches from remote..."
git --git-dir=.bare fetch origin

# Function to find matching branch
find_branch() {
    local input=$1
    local branches
    
    # Get all remote branches
    branches=$(git --git-dir=.bare branch -r | sed 's/origin\///' | sed 's/^[[:space:]]*//' | grep -v '^HEAD')
    
    # Try exact match first
    if echo "$branches" | grep -q "^${input}$"; then
        echo "$input"
        return 0
    fi
    
    # Try with common prefixes
    local prefixes=("feat/" "feature/" "fix/" "bugfix/" "hotfix/" "chore/" "docs/" "refactor/" "test/" "style/")
    
    for prefix in "${prefixes[@]}"; do
        if echo "$branches" | grep -q "^${prefix}${input}$"; then
            echo "${prefix}${input}"
            return 0
        fi
    done
    
    # Try partial match (case-insensitive)
    local matches=$(echo "$branches" | grep -i "$input")
    local match_count=$(echo "$matches" | grep -v '^$' | wc -l | tr -d ' ')
    
    if [ "$match_count" -eq 1 ]; then
        echo "$matches"
        return 0
    elif [ "$match_count" -gt 1 ]; then
        echo "Error: Multiple branches match '$input':" >&2
        echo "$matches" | sed 's/^/  - /' >&2
        return 1
    fi
    
    # No match found - assume it's a new branch name
    echo "$input"
    return 2
}

# Find the branch
BRANCH_NAME=$(find_branch "$BRANCH_INPUT")
FIND_RESULT=$?

if [ $FIND_RESULT -eq 1 ]; then
    # Multiple matches found, error already printed
    exit 1
fi

# Determine worktree directory name (use last part of branch for directory)
WORKTREE_DIR=$(basename "$BRANCH_NAME")

# Check if worktree directory already exists
if [ -d "$WORKTREE_DIR" ]; then
    echo "Worktree directory '$WORKTREE_DIR' already exists. Switching to it..."
    cd "$WORKTREE_DIR"
    echo "✅ Now in worktree: $WORKTREE_DIR"
    echo "   Branch: $(git branch --show-current)"
    exit 0
fi

# Check if branch exists remotely
BRANCH_EXISTS=$(git --git-dir=.bare branch -r | grep -c "origin/${BRANCH_NAME}" || true)

if [ "$BRANCH_EXISTS" -gt 0 ]; then
    echo "Creating worktree for existing branch: $BRANCH_NAME"
    git worktree add "$WORKTREE_DIR" "origin/$BRANCH_NAME"
else
    echo "Branch '$BRANCH_NAME' not found remotely."
    read -p "Create new branch '$BRANCH_NAME'? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        # Find the default/main branch to base off
        DEFAULT_BRANCH=$(git --git-dir=.bare symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@refs/remotes/origin/@@' || echo "main")
        
        # Check if default branch exists, otherwise try common alternatives
        if ! git --git-dir=.bare show-ref --verify --quiet "refs/remotes/origin/$DEFAULT_BRANCH"; then
            for branch in "main" "master" "devnet" "develop"; do
                if git --git-dir=.bare show-ref --verify --quiet "refs/remotes/origin/$branch"; then
                    DEFAULT_BRANCH=$branch
                    break
                fi
            done
        fi
        
        echo "Creating new branch '$BRANCH_NAME' based on '$DEFAULT_BRANCH'..."
        git worktree add -b "$BRANCH_NAME" "$WORKTREE_DIR" "origin/$DEFAULT_BRANCH"
    else
        echo "Cancelled."
        exit 1
    fi
fi

# Switch to the worktree directory
cd "$WORKTREE_DIR"

echo "✅ Switched to worktree: $WORKTREE_DIR"
echo "   Branch: $(git branch --show-current)"
echo "   Path: $(pwd)"
