#!/usr/bin/env bash

# tms - tmux session manager
# Interactive tmux session selector with fzf integration

set -e

cmd_list() {
    # Check if tmux server is running
    if ! tmux list-sessions &>/dev/null; then
        echo "No tmux sessions found"
        return 0
    fi

    # Get list of sessions
    local sessions
    sessions=$(tmux list-sessions -F '#{session_name}' 2>/dev/null | sort)

    if [ -z "$sessions" ]; then
        echo "No tmux sessions found"
        return 0
    fi

    # Check if fzf is available
    if ! command -v fzf &>/dev/null; then
        # Fallback: simple numbered list
        echo "fzf not found, using simple selection:"
        echo "$sessions" | nl -w2 -s'. '
        echo -n "Select session number: "
        read -r selection
        local session_name
        session_name=$(echo "$sessions" | sed -n "${selection}p")
        if [ -z "$session_name" ]; then
            echo "Invalid selection"
            return 1
        fi
        cmd_switch "$session_name"
        return $?
    fi

    # Interactive selection with fzf
    local selected
    selected=$(echo "$sessions" | fzf \
        --height 40% \
        --reverse \
        --border \
        --header 'Select tmux session:' \
        --preview 'tmux list-windows -t {} -F "#{window_name}"' \
        --preview-window=right:50%:wrap)

    if [ -z "$selected" ]; then
        # User cancelled (pressed ESC)
        return 0
    fi

    cmd_switch "$selected"
}

cmd_switch() {
    local session_name="$1"

    # If no session name provided, run interactive selector
    if [ -z "$session_name" ]; then
        cmd_list
        return $?
    fi

    # Verify session exists
    if ! tmux has-session -t "$session_name" 2>/dev/null; then
        echo "Error: Session '$session_name' does not exist"
        return 1
    fi

    # Smart attach/switch based on context
    if [ -n "$TMUX" ]; then
        # Inside tmux: switch client
        tmux switch-client -t "$session_name"
    else
        # Outside tmux: attach session
        tmux attach-session -t "$session_name"
    fi
}

cmd_new() {
    local session_name="$1"
    local command="${2:-}"

    # Validate session name provided
    if [ -z "$session_name" ]; then
        echo "Usage: tms new <session-name> [command]"
        echo "  session-name: Name for the new tmux session (required)"
        echo "  command:      Command to run (optional, defaults to shell)"
        return 1
    fi

    # Check if session already exists
    if tmux has-session -t "$session_name" 2>/dev/null; then
        echo "Error: Session '$session_name' already exists"
        return 1
    fi

    # Create new detached session
    if [ -n "$command" ]; then
        tmux new-session -d -s "$session_name" "$command"
    else
        tmux new-session -d -s "$session_name"
    fi

    echo "Created tmux session: $session_name"
}

cmd_remove() {
    local session_name="$1"

    # If no session name provided, select one interactively
    if [ -z "$session_name" ]; then
        if ! tmux list-sessions &>/dev/null; then
            echo "No tmux sessions found"
            return 0
        fi

        local sessions
        sessions=$(tmux list-sessions -F '#{session_name}' 2>/dev/null | sort)

        if [ -z "$sessions" ]; then
            echo "No tmux sessions found"
            return 0
        fi

        if command -v fzf &>/dev/null; then
            session_name=$(echo "$sessions" | fzf \
                --height 40% \
                --reverse \
                --border \
                --header 'Select tmux session to remove:' \
                --preview 'tmux list-windows -t {} -F "#{window_name}"' \
                --preview-window=right:50%:wrap)
        else
            echo "fzf not found, using simple selection:"
            echo "$sessions" | nl -w2 -s'. '
            echo -n "Select session number to remove: "
            read -r selection
            session_name=$(echo "$sessions" | sed -n "${selection}p")
        fi
    fi

    if [ -z "$session_name" ]; then
        # User cancelled selection
        return 0
    fi

    # Verify session exists
    if ! tmux has-session -t "$session_name" 2>/dev/null; then
        echo "Error: Session '$session_name' does not exist"
        return 1
    fi

    echo -n "Remove tmux session '$session_name'? [y/N]: "
    read -r confirm
    case "$confirm" in
        y|Y|yes|YES)
            tmux kill-session -t "$session_name"
            echo "Removed tmux session: $session_name"
            ;;
        *)
            echo "Cancelled"
            ;;
    esac
}

cmd_help() {
    cat << EOF
tms - tmux session manager

Usage:
  tms [list]              Interactive session selector (default)
  tms switch [session]    Switch to session (interactive if no name given)
  tms new <session> [cmd] Create new detached session
  tms remove [session]    Remove session (interactive if no name given)
  tms help                Show this help message

Examples:
  tms                     # Show interactive session selector
  tms switch work         # Switch directly to 'work' session
  tms new backend         # Create new session named 'backend'
  tms new logs "tail -f app.log"  # Create session running a command
  tms remove work         # Remove session named 'work'

Environment:
  Automatically detects if running inside tmux:
  - Inside tmux:  uses 'switch-client' to change sessions
  - Outside tmux: uses 'attach-session' to connect
EOF
}

main() {
    local cmd="${1:-list}"

    case "$cmd" in
        list)
            cmd_list
            ;;
        switch)
            shift
            cmd_switch "$@"
            ;;
        new)
            shift
            cmd_new "$@"
            ;;
        remove|rm|delete)
            shift
            cmd_remove "$@"
            ;;
        help|--help|-h)
            cmd_help
            ;;
        *)
            echo "Unknown command: $cmd"
            echo "Run 'tms help' for usage information"
            return 1
            ;;
    esac
}

main "$@"
